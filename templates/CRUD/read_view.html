{% extends "menu.html" %} {% block main %}

<form id="search-form" method="get">
  <div class="search-fields card">
    <div class="search-form-row">
      <!-- User selects what column they would like to search in -->
      <div class="input-field">
        <select name="option1">
          <option value="" disabled selected>Choose your option</option>
          {% for key,value in option1Fields.items %}
          <option value="{{ value }}">{{key}}</option>
          {% endfor %}
        </select>
        <label>Column to search</label>
      </div>

      <!-- Here the user chooses the thing to search. If the field is an enum field
        it gives the user options to choose from.-->

      <div class="input-field">
        <input
          id="lsearch_string"
          name="searchString"
          type="text"
          class="validate"
          placeholder=" "
        />
        <label>Search term</label>
      </div>

      <!-- Here the user selects what columns they would like to view on their table -->
      <div class="input-field" id="search-view-columns">
        <select multiple name="option2">
          <option value="" disabled selected>Choose your option</option>
          {% for key in option2Fields %}
          <option>{{key}}</option>
          {% endfor %}
        </select>
        <label>Columns to view</label>
      </div>
    </div>
    <div class="search-form-row-2">
      <label>
        <input type="checkbox" name="archive" class="filled-in" />
        <span>Include archived faculty?</span>
      </label>
      <div class="submit">
        <input
          type="submit"
          value="Submit"
          class="btn waves-effect waves-light"
        />
      </div>
    </div>
  </div>
</form>
<div class="row card">
  <!-- This is where the data shows up! -->
  <div id="myGrid" style="width: 100%" class="ag-theme-material"></div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>
  $(document).ready(function () {
    // define table vars
    var grid = "";
    var column = [];
    var row = [];
    var gridOptions = "";

    function buildTable(column, row) {
      if (grid != "") {
        gridOptions.api.destroy();
      }
      gridOptions = {
        columnDefs: column,
        defaultColDef: {
          sortable: true,
          filter: true,
          resizable: true,
        },
        rowData: row,
        enableRangeSelection: true,
        domLayout: "autoHeight",
        animateRows: true,
      };

      // setup the grid after the page has finished loading
      const gridDiv = document.querySelector("#myGrid");

      grid = new agGrid.Grid(gridDiv, gridOptions);
    }

    // catch the form's submit event
    $("#search-form").submit(function (e) {
      e.preventDefault();
      // create an AJAX call
      $.ajax({
        data: $(this).serialize(), // get the form data
        type: $(this).attr("method"), // GET or POST
        url: "{% url 'search' %}",
        // on success
        success: function (response) {
          column = [];
          row = [];

          for (h in response.tableHeaders) {
            column.push({ headerName: h, field: response.tableHeaders[h] });
          }
          row = response.results;

          buildTable(column, row);
        },
        // on error
        error: function (response) {
          // alert the error if any error occured
          alert(response.responseJSON.errors);
          console.log(response.responseJSON.errors);
        },
      });

      return false;
    });
  });
</script>
{% endblock %}
